## Проект RayTracing

Данный блокнот выполняет задачу **рейтрейсинга** (ray tracing) — метод визуализации, который используется для создания фотореалистичных изображений путем отслеживания пути света через пиксели изображения.

В данном случае код использует **CUDA** для ускорения вычислений на GPU.

Детальное описание проекта
---

### 1. **Импорт библиотек**
- **`numpy`**: Используется для работы с массивами данных.
- **`pycuda`**: Библиотека для работы с CUDA, которая позволяет выполнять вычисления на GPU.
- **`struct`**: Используется для работы с бинарными данными, в частности для создания BMP-файла.

---

### 2. **Конфигурация изображения**
```python
WIDTH = 1024
HEIGHT = 768
MAX_DEPTH = 10
```
- **`WIDTH` и `HEIGHT`**: Размеры изображения в пикселях.
- **`MAX_DEPTH`**: Максимальная глубина рекурсии для трассировки лучей (количество отражений).

---

### 3. **Функция сохранения изображения в BMP**
```python
def save_bmp(filename, image, width, height):
```
Эта функция сохраняет изображение в формате BMP.

- **Заголовок BMP**: Создается структура заголовка BMP, которая включает информацию о размере файла, ширине, высоте и других параметрах.
- **Пиксели**: Изображение записывается построчно, начиная с нижней строки (BMP хранит строки снизу вверх).

---

### 4. **CUDA ядро**
```python
mod = SourceModule("""
```
Здесь определяется CUDA ядро, которое будет выполняться на GPU. Ядро написано на языке C++.

#### 4.1. **Структуры данных**
- **`Vec3`**: Вектор из трех компонентов (x, y, z), представляющий точку, направление или цвет.
  - Реализованы базовые операции: сложение, вычитание, умножение на скаляр, скалярное произведение и нормализация.
- **`Sphere`**: Сфера, заданная центром, радиусом и цветом.
- **`Light`**: Источник света, заданный позицией и интенсивностью.
- **`Plane`**: Плоскость, заданная точкой на плоскости, нормалью и цветом.

#### 4.2. **Функции пересечения**
- **`intersect`**: Проверяет пересечение луча со сферой. Использует квадратное уравнение для нахождения точки пересечения.
- **`intersectPlane`**: Проверяет пересечение луча с плоскостью.

#### 4.3. **Функция трассировки лучей**
- **`traceRay`**: Рекурсивная функция, которая вычисляет цвет пикселя на основе пересечений лучей с объектами.
  - Если луч пересекает объект, вычисляется освещение с учетом источников света и теней.
  - Если луч пересекает несколько объектов, выбирается ближайший.

#### 4.4. **Ядро рендеринга**
- **`renderKernel`**: Основное ядро, которое вызывается для каждого пикселя изображения.
  - Для каждого пикселя вычисляется направление луча.
  - Вызывается функция `traceRay` для получения цвета пикселя.
  - Цвет записывается в массив изображения.

---

### 5. **Настройка данных**
```python
spheres = np.array([...])
lights = np.array([...])
planes = np.array([...])
```
Здесь задаются данные для сцен:
- **Сферы**: Три сферы с разными центрами, радиусами и цветами.
- **Источники света**: Два источника света с разными позициями и интенсивностью.
- **Плоскость**: Одна плоскость, которая служит "полом".

---

### 6. **Выделение памяти на GPU**
```python
spheres_gpu = cuda.mem_alloc(spheres.nbytes)
cuda.memcpy_htod(spheres_gpu, spheres)
```
- Данные копируются из оперативной памяти (CPU) в память GPU для ускорения вычислений.

---

### 7. **Создание изображения**
```python
image = np.zeros(WIDTH * HEIGHT * 3, dtype=np.uint8)
```
Создается пустой массив для хранения изображения. Каждый пиксель представлен тремя байтами (RGB).

---

### 8. **Настройка сетки для выполнения ядра**
```python
block_size = (16, 16, 1)
grid_size = (WIDTH // block_size[0], HEIGHT // block_size[1])
```
- **`block_size`**: Размер блока потоков (16x16 потоков).
- **`grid_size`**: Размер сетки блоков (сколько блоков нужно для покрытия всего изображения).

---

### 9. **Запуск ядра**
```python
render_kernel = mod.get_function("renderKernel")
render_kernel(...)
```
- Ядро `renderKernel` запускается на GPU. Каждый поток вычисляет цвет одного пикселя.

---

### 10. **Сохранение изображения**
```python
save_bmp('output.bmp', image, WIDTH, HEIGHT)
```
- Результирующее изображение сохраняется в файл `output.bmp`.

---

### Как работает рейтрейсинг?
1. Для каждого пикселя изображения вычисляется луч, исходящий из камеры.
2. Проверяется пересечение луча с объектами сцены (сферами и плоскостями).
3. Если луч пересекает объект, вычисляется его цвет с учетом освещения и теней.
4. Результат записывается в массив изображения.
